(window.webpackJsonp=window.webpackJsonp||[]).push([[36],{377:function(t,s,a){"use strict";a.r(s);var n=a(1),e=Object(n.a)({},(function(){var t=this.$createElement;this._self._c;return this._m(0)}),[function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"content"},[a("h1",{attrs:{id:"commonjs-的模块规范"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#commonjs-的模块规范"}},[t._v("#")]),t._v(" CommonJS 的模块规范")]),t._v(" "),a("ul",[a("li",[t._v("内容\n"),a("ul",[a("li",[t._v("模块")]),t._v(" "),a("li",[t._v("二进制")]),t._v(" "),a("li",[t._v("buffer")]),t._v(" "),a("li",[t._v("字节集编码")]),t._v(" "),a("li",[t._v("I/O流")]),t._v(" "),a("li",[t._v("进程环境")]),t._v(" "),a("li",[t._v("文件系统")]),t._v(" "),a("li",[t._v("套接字")]),t._v(" "),a("li",[t._v("单元测试")]),t._v(" "),a("li",[t._v("web服务器网关接口")]),t._v(" "),a("li",[t._v("包管理")])])])]),t._v(" "),a("h2",{attrs:{id:"_1-模块的定义"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-模块的定义"}},[t._v("#")]),t._v(" 1.模块的定义")]),t._v(" "),a("ul",[a("li",[t._v("上下文提供"),a("code",[t._v("require()")]),t._v("方法来引入外部模块")]),t._v(" "),a("li",[t._v("对应功能，上下文提供"),a("code",[t._v("exports")]),t._v("对象用于导出当前模块的方法或变量，也是唯一出口")]),t._v(" "),a("li",[t._v("模块中存在"),a("code",[t._v("module")]),t._v("对象， 代表模块本身")]),t._v(" "),a("li",[a("code",[t._v("exports")]),t._v("是"),a("code",[t._v("module")]),t._v("属性")]),t._v(" "),a("li",[a("code",[t._v("module.exports")])]),t._v(" "),a("li",[a("code",[t._v("exports")])])]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// math.js")]),t._v("\n  exports"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("add")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" sum "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      i "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      args "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" arguments"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      l "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" args"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("i "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" l"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      sum "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+=")]),t._v(" args"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("i"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" sum"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n")])])]),a("h2",{attrs:{id:"_2-模块的使用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-模块的使用"}},[t._v("#")]),t._v(" 2.模块的使用")]),t._v(" "),a("h3",{attrs:{id:"require"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#require"}},[t._v("#")]),t._v(" require()")]),t._v(" "),a("ul",[a("li",[t._v("符合小舵峰命名")]),t._v(" "),a("li",[t._v("可以没有文件后缀名")])]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// program.js")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" math "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'math'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" val "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" math"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("12")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("23")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("43")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("val"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("h2",{attrs:{id:"_3-node-的模块实现"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-node-的模块实现"}},[t._v("#")]),t._v(" 3.node 的模块实现")]),t._v(" "),a("ul",[a("li",[t._v("引入，经历三个步骤\n"),a("ul",[a("li",[t._v("路径分析")]),t._v(" "),a("li",[t._v("文件定位")]),t._v(" "),a("li",[t._v("编译执行")])])])]),t._v(" "),a("h3",{attrs:{id:"核心模块和文件模块"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#核心模块和文件模块"}},[t._v("#")]),t._v(" 核心模块和文件模块")]),t._v(" "),a("h4",{attrs:{id:"优先从缓存加载"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#优先从缓存加载"}},[t._v("#")]),t._v(" 优先从缓存加载")]),t._v(" "),a("ul",[a("li",[t._v("核心模块\n"),a("ul",[a("li",[t._v("在node源代码编译过程中，编译进了二进制文件")]),t._v(" "),a("li",[t._v("node启动时，直接加载进内存中")]),t._v(" "),a("li",[t._v("核心模块使用时省略 文件定位 编译执行")])])]),t._v(" "),a("li",[t._v("文件模块\n"),a("ul",[a("li",[t._v("运行时动态加载")])])])]),t._v(" "),a("h3",{attrs:{id:"路径分析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#路径分析"}},[t._v("#")]),t._v(" 路径分析")]),t._v(" "),a("h4",{attrs:{id:"模块标识符分析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#模块标识符分析"}},[t._v("#")]),t._v(" 模块标识符分析")]),t._v(" "),a("ul",[a("li",[t._v("核心模块 --\x3e 名称查找")]),t._v(" "),a("li",[t._v("自定义模块 --\x3e 路径分析查找")])]),t._v(" "),a("h3",{attrs:{id:"文件定位"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#文件定位"}},[t._v("#")]),t._v(" 文件定位")]),t._v(" "),a("ul",[a("li",[t._v("文件扩展名\n"),a("ul",[a("li",[t._v("查找优先级 .js > .json > .node (一般不是js后缀 要加上)")])])]),t._v(" "),a("li",[t._v("目录分析和包\n"),a("ul",[a("li",[t._v("如果是一个目录 当作包来处理")]),t._v(" "),a("li",[t._v("node在当前的目录下查找 package.json")]),t._v(" "),a("li",[t._v("通过 JSON.parse()解析包描述对象")]),t._v(" "),a("li",[t._v("得到 main属性指定的文件名进行定位")]),t._v(" "),a("li",[t._v("默认文件名 index.js > index.json > index.node")])])])]),t._v(" "),a("h3",{attrs:{id:"编译执行"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#编译执行"}},[t._v("#")]),t._v(" 编译执行")]),t._v(" "),a("ul",[a("li",[t._v("文件模块都是一个对像")]),t._v(" "),a("li",[t._v("定位到具体的文件后， Node会新建一个模块对象，然后根据路径载入并编译")])]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Module")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" parent")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("id "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exports "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("parent "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" parent"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("parent "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" parent"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("children"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    parent"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("children"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("push")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("filename "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("loaded "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("children "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("ul",[a("li",[t._v("不同的文件扩展名，载入的方式也不同\n"),a("ul",[a("li",[t._v(".js文件。 通过fs模块同步读取文件后编译")]),t._v(" "),a("li",[t._v(".node文件。 用 C/C++编写的扩展文件，通过dlopen()方法加载后编译生成的文件")]),t._v(" "),a("li",[t._v(".json文件。 通过fs模块同步读取文件后， 用JSON.parse()解析返回结果")]),t._v(" "),a("li",[t._v("其他当作.js")])])])]),t._v(" "),a("h3",{attrs:{id:"核心模块"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#核心模块"}},[t._v("#")]),t._v(" 核心模块")]),t._v(" "),a("ul",[a("li",[t._v("两部分\n"),a("ul",[a("li",[t._v("C/C++编写 存放在 Node项目的src目录下")]),t._v(" "),a("li",[t._v("JavaScript编写 存放在 Node项目的lib目录下")])])])]),t._v(" "),a("h4",{attrs:{id:"内建模块导出"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#内建模块导出"}},[t._v("#")]),t._v(" 内建模块导出")]),t._v(" "),a("ul",[a("li",[t._v("文件模块 <---- 核心模块(JavaScript) <----- 内建模块(C/C++)")]),t._v(" "),a("li",[t._v("Node 在启动的时候，会生成一个全局变量 process, 并提供 Binding()方法协助加载内建模块")])]),t._v(" "),a("h4",{attrs:{id:"核心模块的引入流程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#核心模块的引入流程"}},[t._v("#")]),t._v(" 核心模块的引入流程")]),t._v(" "),a("div",{staticClass:"language-flow extra-class"},[a("pre",{pre:!0,attrs:{class:"language-flow"}},[a("code",[t._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5.")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'os'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4.")]),t._v(" NativeModule"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'os'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.")]),t._v(" process"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("binding")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'os'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2.")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("get_builtin_module")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'node_os'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NODE_MODULE")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("node_os"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" reg_func"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])])])}],!1,null,null,null);s.default=e.exports}}]);